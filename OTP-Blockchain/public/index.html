<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP Generation and Verification</title>
    <!-- Bootstrap and Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.0.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 500px; }
        .card { border: none; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .btn { height: 50px; }
        .otp-input { width: 100%; height: 60px; font-size: 24px; text-align: center; border: 2px solid #198754; border-radius: 5px; }
        .text-success-icon { font-size: 5rem; }
        .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        border-left: 5px solid #007bff;
        font-family: Arial, sans-serif;
    }
    .notification-content {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .notification i {
        color: red;
        font-size: 24px;
    }
    #close-notification {
        background: #007bff;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
    }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home Page -->
        <div id="home-page" class="card p-4">
            <div class="text-center mb-4">
                <i class="fas fa-home text-success text-success-icon"></i>
                <h2>Welcome</h2>
                <p class="text-muted">Choose an option below:</p>
            </div>
            <button id="signup-option" class="btn btn-primary w-100 mb-3">Newly Sign Up Account</button>
            <button id="login-option" class="btn btn-secondary w-100">Login with Verification</button>
            <button id="admin-view" class="btn btn-info w-100 mb-3">View System Overview</button>
        </div>
    <!-- Sign-Up Page -->
<div id="page-1" class="card p-4">
    <div class="text-center mb-4">
        <i class="fas fa-user-circle text-success text-success-icon"></i>
        <h2>Create an Account</h2>
        <p class="text-muted">Enter your details to create an account</p>
    </div>
    <input type="text" id="name" class="form-control mb-3" placeholder="Name" required />
    <input type="text" id="username" class="form-control mb-3" placeholder="Username" required />
    <input type="email" id="signup-email" class="form-control mb-3" placeholder="Email" required />
    <input type="password" id="password" class="form-control mb-3" placeholder="Password" required />
    <button id="register-user" class="btn btn-success w-100">Sign Up</button>
</div>

<!-- OTP Generation Page -->
<div class="container">
    <div id="page-2" class="card p-4">
        <div class="text-center mb-4">
            <i class="fas fa-key text-success text-success-icon"></i>
            <h2>OTP Generator</h2>
            <p class="text-muted">Click the button to generate your OTP.</p>
        </div>
        <button id="generate-otp" class="btn btn-success w-100">Generate OTP</button>
        <p id="otp-display" class="otp-display text-center"></p> <!-- OTP Display Area -->
    </div>

    <!-- OTP Verification Page with 6 Input Boxes -->
<div id="page-3" class="card p-4">
    <div class="text-center mb-4">
        <h2>OTP Verification</h2>
        <p class="text-muted">Enter the 6-digit OTP below to verify.</p>
    </div>
    <div class="d-flex justify-content-center gap-2">
        <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 'otp2')" id="otp1">
        <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 'otp3')" id="otp2">
        <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 'otp4')" id="otp3">
        <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 'otp5')" id="otp4">
        <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 'otp6')" id="otp5">
        <input type="text" class="otp-input" maxlength="1" id="otp6" oninput="moveToNext(this, null)">
    </div>
    <button id="verify-otp" class="btn btn-primary w-100 mt-3">Verify OTP</button>
    <p id="verification-result" class="text-center text-muted mt-3"></p>
</div>
<!-- Notification Container -->
<div id="notification-container" class="notification" style="display: none;">
  <div class="notification-content">
      <i class="fas fa-bell"></i>
      <div>
          <h4>OTP Generated</h4>
          <p id="otp-message">Your OTP is: </p>
      </div>
      <button id="close-notification">OK</button>
  </div>
</div>
<!--Verification Result-->
<div id="success-page" style="display: none;">
  <h2 style="color: green;">✅ OTP Verified Successfully!</h2>
</div>

<div id="failed-page" style="display: none;">
  <h2 style="color: red;">❌ OTP Verification Failed!</h2>
</div>
<!-- Loading Notification Container -->
<div id="loading-notification" class="notification" style="display: none; border-left-color: #007bff;">
    <div class="notification-content">
        <i class="fas fa-spinner fa-spin"></i>
        <div id="loading-message">Loading...</div>
        <!-- A close button if needed (hidden by default) -->
        <button id="close-loading" style="display: none;">OK</button>
    </div>
  </div>
    <!-- List OTPs and users -->
<div id="admin-page" class="card p-4" style="display: none;">
    <div class="text-center mb-4">
        <h2>System Overview</h2>
        <p class="text-muted">List of all OTPs and registered users</p>
    </div>
    <div>
        <h3>Generated OTPs</h3>
        <table id="otp-table" class="table table-striped">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Account</th>
                    <th>OTP</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div>
        <h3>Registered Users</h3>
        <table id="user-table" class="table table-striped">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Username</th>
                    <th>Email</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <button id="back-home" class="btn btn-secondary">Back to Home</button>
</div>

     <!-- where React app will be rendered -->
  <div id="root"></div>

    <!-- Load Web3.js and Custom JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
     <!-- Add in head section of index.html -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // Connect to MetaMask when the page loads
        window.addEventListener('load', async () => {
          if (typeof window.ethereum !== 'undefined') {
            console.log("MetaMask detected.");
            try {
              // Request account access if needed
              await window.ethereum.request({ method: 'eth_requestAccounts' });
              // Create a Web3 instance using MetaMask's provider
              window.web3 = new Web3(window.ethereum);
              const accounts = await window.web3.eth.getAccounts();
              window.account = accounts[0];
              console.log("Connected MetaMask account:", window.account);
              // OPTIONAL: If you have a global initialization function (e.g., initWeb3AndContract from your React app),
              // you can call it here to initialize your contract instances.
            } catch (error) {
              console.error("Error connecting to MetaMask:", error);
            }
          } else {
            console.error("MetaMask not found! Please install MetaMask.");
          }
        }); </script>
        <script>
          document.addEventListener("otpNotification", function(event) {
            const otpDisplayElem = document.getElementById("otp-display");
            if (otpDisplayElem) {
              otpDisplayElem.innerText = "Your OTP is: " + event.detail.otp;
            }
          });
        </script>
        
        <script>
        function showPage(pageId) {
        const pages = ['home-page', 'page-1', 'page-2', 'page-3', 'admin-page'];
        pages.forEach(page => {
        const element = document.getElementById(page);
        if (element) {
         element.style.display = page === pageId ? 'block' : 'none';
         console.log(`Page '${page}' is now ${page === pageId ? 'visible' : 'hidden'}.`);
           } else {
        console.error(`Page '${page}' not found.`);
        }
        });
        }

        function verifyOTP() {
    let inputOTP = document.getElementById("otp-input").value; // Get user input
    console.log("Verifying OTP with numeric value:", inputOTP);

    if (inputOTP === generatedOTP) { // OTP is correct
        console.log("Verification result: Success");
        showNotification("✅ OTP Verified Successfully!", "green");
        switchPage("success-page");
    } else { // OTP is incorrect
        console.log("Verification result: Failed");
        showNotification("❌ OTP Verification Failed. Please try again.", "red");
        switchPage("failed-page");
    }
}

// Function to display notifications
function showNotification(message, color) {
    let notification = document.createElement("div");
    notification.innerText = message;
    notification.style.position = "fixed";
    notification.style.bottom = "20px";
    notification.style.right = "20px";
    notification.style.padding = "15px 20px";
    notification.style.backgroundColor = color;
    notification.style.color = "white";
    notification.style.fontSize = "16px";
    notification.style.borderRadius = "5px";
    notification.style.boxShadow = "0px 4px 6px rgba(0, 0, 0, 0.1)";
    document.body.appendChild(notification);

    // Remove notification after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

//  **Function to Switch Pages Based on OTP Verification Result**
function switchPage(pageId) {
    document.getElementById("success-page").style.display = "none";
    document.getElementById("failed-page").style.display = "none";

    document.getElementById(pageId).style.display = "block";
}

        

    
        document.getElementById('signup-option').addEventListener('click', () => {
            showPage('page-1');
        });
    
        document.getElementById('login-option').addEventListener('click', () => {
            showPage('page-2');
        });
    
        document.getElementById('register-user').addEventListener('click', () => {
            alert("Account created successfully!");
            showPage('home-page');
        });
    
        document.getElementById('generate-otp').addEventListener('click', async () => {
  console.log("Generate OTP button clicked.");
  try {
    const success = await generateOtp();

    if (success) {
      console.log("OTP generated successfully.");
      showPage('page-3'); // Switch to OTP verification page
    } else {
      console.error("Failed to generate OTP.");
      alert("Failed to generate OTP. Please try again.");
    }
  } catch (error) {
    console.error("Error during OTP generation:", error);
    alert("An error occurred while generating OTP. Please try again.");
  }
});

function moveToNext(currentInput, nextInputId) {
        if (currentInput.value.length === 1 && nextInputId) {
            document.getElementById(nextInputId).focus();
        }
    }

    document.getElementById('verify-otp').addEventListener('click', () => {
        const otp = Array.from({ length: 6 }, (_, i) => document.getElementById(`otp${i + 1}`).value).join('');
        console.log("Entered OTP:", otp);
        if (window.verifyOtp) {
            window.verifyOtp(otp);
        } else {
            console.error("verifyOtp function not available");
        }
    });

// Handle MetaMask errors
document.getElementById('admin-view').addEventListener('click', () => {
  if (!contract || !authenticateContract || !account) {
    alert("Please connect MetaMask first!");
    return;
  }
  showPage('admin-page');
  fetchSystemData();
});
document.addEventListener("loadingStatus", function(event) {
    const loadingContainer = document.getElementById("loading-notification");
    const loadingMessageElem = document.getElementById("loading-message");
    if (loadingContainer && loadingMessageElem) {
      const msg = event.detail.message;
      if (msg && msg.trim() !== "") {
        loadingMessageElem.innerText = msg;
        loadingContainer.style.display = "flex";
      } else {
        loadingContainer.style.display = "none";
      }
    }
  });

// OTP Noti
document.addEventListener("otpNotification", function(event) {
    const otpMessageElem = document.getElementById("otp-message");
    const notification = document.getElementById("notification-container");
    const closeNotification = document.getElementById("close-notification");

    if (otpMessageElem && notification) {
        otpMessageElem.innerText = "Your OTP is: " + event.detail.otp;
        notification.style.display = "flex";
    } else {
        console.error("OTP message or notification container not found.");
    }

    // Close notification on button click
    if (closeNotification) {
        closeNotification.addEventListener("click", function () {
            notification.style.display = "none";
        });
    }
});

          document.getElementById('back-home').addEventListener('click', () => {
    showPage('home-page');
});


    
        // Initialize Home Page
        showPage('home-page');
    </script>
    
</body>
</html>
